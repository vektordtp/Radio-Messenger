<!DOCTYPE html>
<html lang="bs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RadioMessenger - AFSK</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.0/lucide.min.css" rel="stylesheet">
    <style>
        body { background-color: #0f172a; color: white; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Ikone (zamjena za lucide-react komponente jer koristimo CDN)
        const Icon = ({ name, size = 20, className = "" }) => (
            <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>
        );

        const MARK_FREQ = 1200;
        const SPACE_FREQ = 2200;
        const BAUD_RATE = 300;
        const BIT_DURATION = 1 / BAUD_RATE;

        function App() {
            const [inputText, setInputText] = useState('');
            const [messages, setMessages] = useState([]);
            const [isReceiving, setIsReceiving] = useState(false);
            const [isTransmitting, setIsTransmitting] = useState(false);
            const [status, setStatus] = useState('Spreman');
            
            const audioContextRef = useRef(null);
            const micStreamRef = useRef(null);

            useEffect(() => {
                // Inicijalizacija Lucide ikona nakon renderovanja
                if (window.lucide) window.lucide.createIcons();
            }, [messages, isReceiving, isTransmitting]);

            const initAudio = () => {
                if (!audioContextRef.current) {
                    audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
                }
            };

            const transmitText = async () => {
                if (!inputText) return;
                initAudio();
                setIsTransmitting(true);
                setStatus('Slanje...');

                const ctx = audioContextRef.current;
                const now = ctx.currentTime;
                let timeOffset = 0.5;

                const encoder = new TextEncoder();
                const data = encoder.encode(inputText);
                
                const bits = [];
                for(let i = 0; i < 16; i++) bits.push(i % 2); // Preambula
                
                data.forEach(byte => {
                    for (let i = 7; i >= 0; i--) {
                        bits.push((byte >> i) & 1);
                    }
                });

                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);
                oscillator.type = 'sine';
                
                bits.forEach((bit, index) => {
                    const freq = bit === 1 ? MARK_FREQ : SPACE_FREQ;
                    oscillator.frequency.setValueAtTime(freq, now + timeOffset + (index * BIT_DURATION));
                });

                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(0.5, now + 0.1);
                gainNode.gain.setValueAtTime(0.5, now + timeOffset + (bits.length * BIT_DURATION));
                gainNode.gain.linearRampToValueAtTime(0, now + timeOffset + (bits.length * BIT_DURATION) + 0.1);

                oscillator.start(now);
                oscillator.stop(now + timeOffset + (bits.length * BIT_DURATION) + 0.2);

                setTimeout(() => {
                    setIsTransmitting(false);
                    setStatus('Spreman');
                    setMessages(prev => [...prev, { text: inputText, type: 'sent', time: new Date().toLocaleTimeString() }]);
                    setInputText('');
                }, (timeOffset + (bits.length * BIT_DURATION) + 0.5) * 1000);
            };

            const toggleReceiver = async () => {
                if (isReceiving) {
                    if (micStreamRef.current) micStreamRef.current.getTracks().forEach(t => t.stop());
                    setIsReceiving(false);
                    setStatus('Spreman');
                } else {
                    try {
                        initAudio();
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        micStreamRef.current = stream;
                        setIsReceiving(true);
                        setStatus('Prijem aktivan');
                    } catch (err) {
                        setStatus('Greška mikrofona');
                    }
                }
            };

            return (
                <div className="min-h-screen p-4 flex flex-col items-center">
                    <div className="w-full max-w-md bg-slate-800 rounded-3xl shadow-2xl overflow-hidden flex flex-col border border-slate-700">
                        
                        <div className="bg-slate-700 p-5 flex items-center justify-between border-b border-slate-600">
                            <div className="flex items-center gap-3">
                                <div className="p-2 bg-blue-500 rounded-lg">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4.9 19.1C1 15.2 1 8.8 4.9 4.9"/><path d="M7.8 16.2c-2.3-2.3-2.3-6.1 0-8.5"/><circle cx="12" cy="12" r="2"/><path d="M16.2 7.8c2.3 2.3 2.3 6.1 0 8.5"/><path d="M19.1 4.9C23 8.8 23 15.2 19.1 19.1"/></svg>
                                </div>
                                <h1 className="font-bold text-xl">RadioMessenger</h1>
                            </div>
                            <div className="flex items-center gap-2 bg-slate-900/50 px-3 py-1 rounded-full border border-white/5">
                                <div className={`w-2 h-2 rounded-full ${isReceiving ? 'bg-green-500 animate-pulse' : isTransmitting ? 'bg-red-500 animate-pulse' : 'bg-slate-500'}`}></div>
                                <span className="text-[10px] uppercase font-bold tracking-widest text-slate-300">{status}</span>
                            </div>
                        </div>

                        <div className="flex-1 h-[45vh] overflow-y-auto p-4 space-y-4 bg-slate-900/30">
                            {messages.length === 0 ? (
                                <div className="h-full flex flex-col items-center justify-center text-slate-600 text-center p-10">
                                    <p className="text-sm italic">Spremno za prenos preko UHF/VHF talasa. Povežite audio kabl na radio stanicu.</p>
                                </div>
                            ) : (
                                messages.map((msg, idx) => (
                                    <div key={idx} className={`flex flex-col ${msg.type === 'sent' ? 'items-end' : 'items-start'}`}>
                                        <div className={`max-w-[85%] p-3 px-4 rounded-2xl shadow-md ${msg.type === 'sent' ? 'bg-blue-600 rounded-tr-none' : 'bg-slate-700 rounded-tl-none'}`}>
                                            <p className="text-sm leading-relaxed">{msg.text}</p>
                                        </div>
                                        <span className="text-[9px] text-slate-500 mt-1 font-mono uppercase">{msg.time}</span>
                                    </div>
                                ))
                            )}
                        </div>

                        <div className="p-4 bg-slate-800/80 border-t border-slate-700">
                            <div className="flex gap-2 mb-4">
                                <button 
                                    onClick={toggleReceiver}
                                    className={`flex-1 flex items-center justify-center gap-2 py-3 rounded-2xl font-bold transition-all active:scale-95 ${isReceiving ? 'bg-red-500/10 text-red-500 border border-red-500/50' : 'bg-slate-700 hover:bg-slate-600 text-slate-200'}`}
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
                                    {isReceiving ? 'Ugasi Prijem' : 'Slušaj'}
                                </button>
                                <button 
                                    onClick={() => setMessages([])}
                                    className="px-4 py-3 bg-slate-700 rounded-2xl hover:bg-slate-600 transition-colors active:scale-95 text-slate-400"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                                </button>
                            </div>

                            <div className="relative group">
                                <textarea
                                    value={inputText}
                                    onChange={(e) => setInputText(e.target.value)}
                                    placeholder="Ukucajte poruku..."
                                    className="w-full bg-slate-900/80 border border-slate-700 rounded-2xl p-4 pr-14 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all resize-none h-24 placeholder:text-slate-600 shadow-inner"
                                    disabled={isTransmitting}
                                />
                                <button 
                                    onClick={transmitText}
                                    disabled={isTransmitting || !inputText}
                                    className={`absolute bottom-4 right-4 p-3 rounded-xl transition-all active:scale-90 ${!inputText || isTransmitting ? 'text-slate-700' : 'bg-blue-600 hover:bg-blue-500 text-white shadow-lg shadow-blue-600/30'}`}
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" x2="11" y1="2" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                                </button>
                            </div>
                        </div>

                        <div className="p-3 bg-slate-950 text-[10px] text-slate-500 text-center font-bold uppercase tracking-[0.2em]">
                            AFSK DIGITAL • 300 BAUD • HAM RADIO READY
                        </div>
                    </div>
                    
                    <div className="mt-6 text-slate-500 text-xs text-center max-w-xs">
                        Napomena: Za prenos koristite audio-izlaz telefona spojen na MIC ulaz radio stanice. Koristite VOX ili manuelni PTT.
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

